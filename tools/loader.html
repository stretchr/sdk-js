<!DOCTYPE html>
<html>
	<head>
		<title>Data Loader - v1 - Stretchr</title>
		<link href="css/reset.css" rel="stylesheet" />
		<link href="css/tools.css" rel="stylesheet" />
	</head>
	<body>

		<div id="header">
			<h1>Data Loader</h1>
			<em>
				Loads bulk data into Stretchr, great for testing.
			</em>
		</div>

		<div class="section setup">

			<div class="form">
				<h2>
					Account
				</h2>
				<label>
					<span>Project name:</span>
					<input type="text" name="project-name" />
					<code>.stretchr.com</code>
				</label>
				<label>
					<span>Public key:</span>
					<input type="text" name="public-key" />
				</label>
				<label>
					<span>Private key:</span>
					<input type="text" name="private-key" />
				</label>
			</div>
			
			<div class="form">
				<h2>
					Path
				</h2>
				<label>
					<span>Post to <code>/api/v1/</code></span>
					<input type="text" name="path" />
					<code>/</code>
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em class="eg">e.g. "people" or "people/1/books"</em>
				</label>
			</div>
			
			<div class="form">
				<h2>
					Data
				</h2>
				<label>
					<span>Resource template</span>
					<textarea name="data-template">{
  "index": <%=counter%>,
  "key": "<%=hash%>",
  "date": <%=now%>,
  "time": <%=timestamp_year%>,
  "recent": <%=timestamp_month%>,
  "today": <%=timestamp_day%>,
  "custom": <%=myFunc%>
}</textarea>
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em >
						<ul>
							<li><code><%=counter%></code> - An incremental integer</li>
							<li><code><%=hash%></code> - A random hash of alpha-numberic characters</li>
							<li><code><%=now%></code> - A unix timestamp of now</li>
							<li><code><%=timestamp_year%></code> - A random timestamp this year</li>
							<li><code><%=timestamp_year_until_now%></code> - A random timestamp so far this year</li>
							<li><code><%=timestamp_month%></code> - A random timestamp this month</li>
							<li><code><%=timestamp_day%></code> - A random timestamp at some point today</li>
							<li><code><%=random%></code> - A random number between 0 and 1</li>
							<li><code><%=random_bool%></code> - Randomly <code>"true"</code> or <code>"false"</code></li>
							<li><code><%=random_percentage%></code> - A random number between 0 and 100</li>
							<li><code><%=random_location%></code> - A random location object</li>
							<li><code><%=myFunc%></code> - Uses the value from <code>myFunc</code> function (see Custom data functions)</li>
						</ul>
					</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Custom data functions
				</h2>
				<label>
					<span>JavaScript code</span>
					<textarea name="custom-functions">window.myFunc = function(index, resource){ 
  return index+1;
}</textarea>
				<em>
					Write any custom code to generate values here.  You can use the function names in
					the data template
				</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Preferences
				</h2>
				<label>
					<span>Count</span>
					<select name="count">
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>5</option>
						<option selected>10</option>
						<option>20</option>
						<option>30</option>
						<option>50</option>
						<option>100</option>
					</select>
					<em>
						The number of resources to create
					</em>
				</label>
				<!--
				<label>
					<span>Additional parameters</span>
					<input type="text" name="params" />
					<em>URL string of additional parameters to send with each request</em>
					<em class="eg">e.g. "~exclude=~stamps&amp;~include=~parent"</em>
				</label>
			-->
			</div>

			<div class="form">
				<h2>
					Dry run
				</h2>
				<label>
					<span>All set?</span>
					<input type="button" value="Perform dry run" data-action="DryRun" />
				</label>
			</div>

		</div>

		<div class="section dry-run">

			<div class="form">
				<h2>
					Example output
				</h2>
				<textarea class="big" name="dry-run-results"></textarea>
				<label>
					<span>Happy?</span>
					<input type="button" value="Begin making requests..." data-action="BeginMakingRequests" />
				</label>
				<label>
					<span>or</span>
					<input type="button" value="Make some changes" data-action="MakeChanges" />
				</label>
			</div>

		</div>

		<div class="section really-working">

			<div class="form">
				<h2>
					Please wait...
				</h2>
				<label>
					<div class="progress">
						<div class="track"></div>
					</div>
				</label>
				<textarea class="big" name="actual-work-output"></textarea>
				<label>
					<span>What now?</span>
					<input type="button" value="Let's do some more..." data-action="MakeChanges" />
				</label>
			</div>

		</div>

		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="js/stretchr.js"></script>
		<script>

			/*
				loader
				by Mat Ryer
			*/

			/*
				requests holds the request that will be made
			*/
			var requests = [];

			/*
				responsesCount holds the number of successful responses
				that have come back
			*/
			var responsesCount = 0;

			/*
				progressColor holds the CSS color of the progress bar.
			*/
			var progressColor = "green";

			var count, template;

			/*
				on ready
			*/
			$(function(){

				switchToSection("setup", false);

				$("input[type=\"button\"]").click(function(){
					var $this = $(this);
					window["on" + $this.attr("data-action")]($this);
				});

			});

			/*
				doDryRun starts the dry run.
			*/
			function onDryRun() {

				switchToSection("dry-run");
				dryRunResults = $("textarea[name='dry-run-results']").val("");

				if (!go(function(ok, data){

					// add this to the dry run results
					dryRunResults.val(
						dryRunResults.val() + data + "\n"
					);

				})) {
				
					// failed :-(
				  switchToSection("setup");

				};
			
			}

			function onMakeChanges() {

				switchToSection("setup");

			}

			/*
				go generates the resources and calls handler for each
				one.
			*/
			function go(handler) {

				// execute the custom functions
				try {
					//handler(false, "Evaluating custom code:\n\n---\n" + $("textarea[name='custom-functions']").val())

					eval("(" + $("textarea[name='custom-functions']").val() + ")");

					//handler(false, "---\n... custom code OK.\n\n")
				} catch(e) {
					alert("Error executing your Custom data functions:\n\n" + e)
					return false;
				}

				count = $("select[name='count']").val();
				template = $("textarea[name='data-template']").val();

				// template items
				var counter = 1;

				// for each resource...
				for (var i = 0; i < count; i++) {

					var thisTemplate = template;

					thisTemplate = thisTemplate.replace("<%=counter%>", counter++);
					thisTemplate = thisTemplate.replace("<%=hash%>", Stretchr.hash(Date() + counter));
					thisTemplate = thisTemplate.replace("<%=now%>", toUnixTime(new Date()));

					// handle custom functions
					newOutput = "("
					if (thisTemplate.indexOf("<%=") > -1) {
						segs1 = thisTemplate.split("<%=")
						for (s in segs1) {
							seg = segs1[s]
							if (seg.indexOf("%>") > -1) {
								segs2 = seg.split("%>");
								functionName = segs2[0];

								try {
									if (eval("typeof window." + functionName) != "function") {
										newOutput += "\"" + functionName + "() is not a function\""
									} else {
										value = eval(functionName + "(" + i + ", thisTemplate);")
										newOutput += value; 
									}
								} catch(e) {
									handler(false, "Failed to execute custom function: " + e + "\n" + thisTemplate + "\n");
								}

								newOutput += segs2[1];
							} else {
								newOutput += seg
							}
						}
					}
					newOutput += ")"

					// trim all whitespace
					while (newOutput.indexOf("\n") > -1) {
						newOutput = newOutput.replace("\n", "");
					}
					while (newOutput.indexOf("\r") > -1) {
						newOutput = newOutput.replace("\r", "");
					}
					while (newOutput.indexOf("\t") > -1) {
						newOutput = newOutput.replace("\t", "");
					}
					while (newOutput.indexOf("  \"") > -1) {
						newOutput = newOutput.replace("  \"", "\"");
					}
					while (newOutput.indexOf(": ") > -1) {
						newOutput = newOutput.replace(": ", ":");
					}

					var resource;
					try {
						resource = eval(newOutput);
					} catch(e) {
						// report this error to the handler
						handler(false, "Couldn't create resource object: " + e + "\n" + newOutput + "\n");
						continue;
					}

					var projectName = $("input[name='project-name']").val();
					var publicKey = $("input[name='public-key']").val();
					var privateKey = $("input[name='private-key']").val();
					var path = $("input[name='path']").val();
					var stretchr = Stretchr.NewSession(projectName, publicKey, privateKey);

					var req = stretchr.at(path).body(resource);

					/*
					var paramString = $("input[name='params']").val();
					if (paramString.length > 0) {

						segs = paramString.split("&");
						for (s in segs) {
							seg = segs[s];
							keyval = seg.split("=")
							req.with(keyval[0], keyval[1])

						}

					}
					*/

					handler(true, (i + 1) + ") GET " + req.signedUrl() + "\n\n" + JSON.stringify(resource, null, "  ") + "\n", resource, i, req);

				}

				// success
				return true;

			}

			function onBeginMakingRequests() {

				responsesCount = 0;

				switchToSection("really-working");
				updateProgress(0, "green", false);
				var actualWorkOutput = $("textarea[name='actual-work-output']");

				if (!go(function(ok, data, resource, index, request){

					actualWorkOutput.val(
						actualWorkOutput.val() + "Making request " + index + "\n"
					);

					// create the resource
					request.create(onRequestCompleted);

				})) {
				
					// failed :-(
				  switchToSection("setup");

				};

			}

			function onRequestCompleted(response) {

				var actualWorkOutput = $("textarea[name='actual-work-output']");
				actualWorkOutput.val(
					actualWorkOutput.val() + "Received response:\n" +  JSON.stringify(response) + "\n\n"
				);

				if (response["~s"] != 200) {
					progressColor = "red";
				}

				// increase the progress
				responsesCount++;

				if (responsesCount == count) {

					updateProgress(100, progressColor, true);

				} else {
		
					// update the progress bar
					updateProgress(100 / (count / responsesCount), progressColor, true);

				}

			}

			function updateProgress(percentage, color, animated) {

				if (animated) {

					$(".progress .track")
						.width(percentage + "%");
				} else {

					$(".progress .track")
						.width(percentage + "%")
						.css({backgroundColor: color})

				}

			}

			/*
				Opens the specified section and closes all others.
			*/
			function switchToSection(section, animated) {

				if (typeof animated == "undefined") {
					animated = true;
				}

				$("div.section").each(function(){
					var $this = $(this);
					if (!$this.hasClass(section)) {
						if (animated) {
							$this.slideUp();
						} else {
							$this.hide();
						}
					} else {
						if (animated) {
							$this.slideDown();
						} else {
							$this.show();
						}					
					}
				})

			}

			/*
				Data helpers
			*/

			function toUnixTime(d) {
				return Math.floor(d.getTime()/1000);
			}

		  function timestamp_day(index, template) {

				var start = new Date()
				var end = new Date()

				start.setHours(0);
				start.setMinutes(0);
				start.setSeconds(0);

				end.setHours(23);
				end.setMinutes(59);
				end.setSeconds(59);

				return toUnixTime(randomDate(start, end));
			}
			
		  function timestamp_month(index, template) {

				var start = new Date()
				var end = new Date()

				start.setHours(0);
				start.setMinutes(0);
				start.setSeconds(0);
				start.setDate(0);

				end.setHours(23);
				end.setMinutes(59);
				end.setSeconds(59);
				end.setDate(28);

				return toUnixTime(randomDate(start, end));

			}

		  function timestamp_year(index, template) {

				var start = new Date()
				var end = new Date()

				start.setHours(0);
				start.setMinutes(0);
				start.setSeconds(0);
				start.setDate(0);
				start.setMonth(1);

				end.setHours(23);
				end.setMinutes(59);
				end.setSeconds(59);
				end.setDate(28);
				end.setMonth(12);

				return toUnixTime(randomDate(start, end));

			}

			function timestamp_year_until_now(index, template) {

				var start = new Date()
				var end = new Date()

				start.setHours(0);
				start.setMinutes(0);
				start.setSeconds(0);
				start.setDate(0);
				start.setMonth(1);

				return toUnixTime(randomDate(start, end));

			}

			function random() {
				return Math.random();
			}

			function random_percentage() {
				return random() * 100;
			}

			function random_location() {

				var lat = 40.01601711804619 + (-0.5 + (Math.random() * 1));
				var lng = -105.2490574057836 + (-0.5 + (Math.random() * 1));
				var alt = 1268.254028320312 + (-25 + (Math.random() * 50));

				return "{\"lat\":" + lat + ",\"lng\":" + lng + ",\"alt\":" + alt + "}";
			}

			function random_bool() {
				if (Math.random() > 0.5) {
					return "false";
				} else {
					return "true";
				}
			}

			// thanks http://stackoverflow.com/questions/9035627/elegant-method-to-generate-array-of-random-dates-within-two-dates
			function randomDate(start, end) {
			    return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
			}

		</script>
	</body>
</html>
