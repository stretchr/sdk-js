<!DOCTYPE html>
<html>
	<head>
		<title>Data Loader - v1 - Stretchr</title>
		<link href="css/reset.css" rel="stylesheet" />
		<link href="css/tools.css" rel="stylesheet" />
	</head>
	<body>

		<div id="header">
			<h1>Data Loader</h1>
			<em>
				Loads bulk data into Stretchr, great for testing.
			</em>
		</div>

		<div class="section setup">

			<div class="form">
				<h2>
					Account
				</h2>
				<label>
					<span>Project name:</span>
					<input type="text" name="project-name" />
				</label>
				<label>
					<span>Public key:</span>
					<input type="text" name="public-key" />
				</label>
				<label>
					<span>Private key:</span>
					<input type="text" name="private-key" />
				</label>
			</div>
			
			<div class="form">
				<h2>
					Path
				</h2>
				<label>
					<span>Post to /</span>
					<input type="text" name="project-name" />
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em class="eg">e.g. "people" or "people/1/books"</em>
				</label>
			</div>
			
			<div class="form">
				<h2>
					Data
				</h2>
				<label>
					<span>Resource template</span>
					<textarea name="data-template">{
  "index": <%=counter%>,
  "key": "<%=hash%>",
  "date": <%=now%>,
  "time": <%=timestamp_year%>,
  "recent": <%=timestamp_month%>,
  "today": <%=timestamp_day%>,
  "custom": <%=myFunc%>
}</textarea>
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em >
						<ul>
							<li><code><%=counter%></code> - An incremental integer</li>
							<li><code><%=hash%></code> - A random hash of alpha-numberic characters</li>
							<li><code><%=now%></code> - A unix timestamp of now</li>
							<li><code><%=timestamp_year%></code> - A random timestamp within the past year</li>
							<li><code><%=timestamp_month%></code> - A random timestamp within the past month</li>
							<li><code><%=timestamp_day%></code> - A random timestamp today</li>
							<li><code><%=myFunc%></code> - Uses the value from <code>myFunc</code> function (see Custom data functions)</li>
						</ul>
					</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Custom data functions
				</h2>
				<label>
					<span>JavaScript code</span>
					<textarea name="custom-functions">window.myFunc = function(index, resource){ 
  return index+1;
}</textarea>
				<em>
					Write any custom code to generate values here.  You can use the function names in
					the data template
				</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Preferences
				</h2>
				<label>
					<span>Count</span>
					<select name="count">
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>5</option>
						<option selected>10</option>
						<option>20</option>
						<option>30</option>
						<option>50</option>
						<option>100</option>
					</select>
					<em>
						The number of resources to create
					</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Dry run
				</h2>
				<label>
					<span>All set?</span>
					<input type="button" value="Perform dry run" data-action="DryRun" />
				</label>
			</div>

		</div>

		<div class="section dry-run">

			<div class="form">
				<h2>
					Results
				</h2>
				<textarea class="big" name="dry-run-results"></textarea>
				<label>
					<span>Happy?</span>
					<input type="button" value="Begin making requests..." data-action="BeginMakingRequests" />
				</label>
				<label>
					<span>or</span>
					<input type="button" value="Make some changes" data-action="MakeChanges" />
				</label>
			</div>

		</div>

		<div class="section really-working">

			<div class="form">
				<h2>
					Please wait...
				</h2>
				<label>
					<div class="progress">
						<div class="track"></div>
					</div>
				</label>
				<textarea class="big" name="actual-work-output"></textarea>
			</div>

		</div>

		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="../src/stretchr.js"></script>
		<script>

			/*
				loader
				by Mat Ryer
			*/

			/*
				requests holds the request that will be made
			*/
			var requests = [];

			/*
				on ready
			*/
			$(function(){

				switchToSection("setup", false);

				$("input[type=\"button\"]").click(function(){
					var $this = $(this);
					window["on" + $this.attr("data-action")]($this);
				});

			});

			/*
				doDryRun starts the dry run.
			*/
			function onDryRun() {

				switchToSection("dry-run");
				dryRunResults = $("textarea[name='dry-run-results']").val("");

				if (!go(function(ok, data){

					// add this to the dry run results
					dryRunResults.val(
						dryRunResults.val() + data + "\n"
					);

				})) {
				
					// failed :-(
				  switchToSection("setup");

				};
			
			}

			function onMakeChanges() {

				switchToSection("setup");

			}

			/*
				go generates the resources and calls handler for each
				one.
			*/
			function go(handler) {

				// execute the custom functions
				try {
					//handler(false, "Evaluating custom code:\n\n---\n" + $("textarea[name='custom-functions']").val())

					eval("(" + $("textarea[name='custom-functions']").val() + ")");

					//handler(false, "---\n... custom code OK.\n\n")
				} catch(e) {
					alert("Error executing your Custom data functions:\n\n" + e)
					return false;
				}

				var count = $("select[name='count']").val();
				var template = $("textarea[name='data-template']").val();

				// template items
				var counter = 1;

				// for each resource...
				for (var i = 0; i < count; i++) {

					var thisTemplate = template;

					thisTemplate = thisTemplate.replace("<%=counter%>", counter++);
					thisTemplate = thisTemplate.replace("<%=hash%>", Stretchr.hash(Date() + counter));
					thisTemplate = thisTemplate.replace("<%=now%>", toUnixTime(new Date()));

					// handle custom functions
					newOutput = "("
					if (thisTemplate.indexOf("<%=") > -1) {
						segs1 = thisTemplate.split("<%=")
						for (s in segs1) {
							seg = segs1[s]
							if (seg.indexOf("%>") > -1) {
								segs2 = seg.split("%>");
								functionName = segs2[0];

								try {
									if (eval("typeof window." + functionName) != "function") {
										newOutput += "\"" + functionName + "() is not a function\""
									} else {
										value = eval(functionName + "(" + i + ", thisTemplate);")
										newOutput += value; 
									}
								} catch(e) {
									handler(false, "Failed to execute custom function: " + e + "\n" + thisTemplate + "\n");
								}

								newOutput += segs2[1];
							} else {
								newOutput += seg
							}
						}
					}
					newOutput += ")"

					// trim all whitespace
					while (newOutput.indexOf("\n") > -1) {
						newOutput = newOutput.replace("\n", "");
					}
					while (newOutput.indexOf("\r") > -1) {
						newOutput = newOutput.replace("\r", "");
					}
					while (newOutput.indexOf("\t") > -1) {
						newOutput = newOutput.replace("\t", "");
					}
					while (newOutput.indexOf("  \"") > -1) {
						newOutput = newOutput.replace("  \"", "\"");
					}
					while (newOutput.indexOf(": ") > -1) {
						newOutput = newOutput.replace(": ", ":");
					}

					var resource;
					try {
						resource = eval(newOutput);
					} catch(e) {
						// report this error to the handler
						handler(false, "Couldn't create resource object: " + e + "\n" + newOutput + "\n");
						continue;
					}

					handler(true, i + ") POST " + "/sss" + "\n" + JSON.stringify(resource) + "\n", resource, i);

				}

				// success
				return true;

			}

			function onBeginMakingRequests() {

				switchToSection("really-working");
				updateProgress(0, "green", false);
				var actualWorkOutput = $("textarea[name='actual-work-output']")
				var stretchr = Stretchr.NewSession("test", "rz9eZ6V9L19Yzclt0H4TvhkYnD09OHoA", "vh8iXLuVNvm5I7KQdn8OYaMJ534E7YK6");

				if (!go(function(ok, data, resource, index){

					actualWorkOutput.val(
						actualWorkOutput.val() + "Making request " + index + "\n"
					);

					// create the resource
					stretchr.at("/people").body(resource).create(onRequestCompleted);

				})) {
				
					// failed :-(
				  switchToSection("setup");

				};

			}

			function onRequestCompleted(response) {
				var actualWorkOutput = $("textarea[name='actual-work-output']");
				actualWorkOutput.val(
					actualWorkOutput.val() + "Response: " +  JSON.stringify(response) + "\n"
				);
			}

			function updateProgress(percentage, color, animated) {

				if (animated) {

					$(".progress .track")
						.animate({width: percentage + "%", backgroundColor: color});

				} else {

					$(".progress .track")
						.width(percentage + "%")
						.css({backgroundColor: color})

				}

			}

			/*
				Opens the specified section and closes all others.
			*/
			function switchToSection(section, animated) {

				if (typeof animated == "undefined") {
					animated = true;
				}

				$("div.section").each(function(){
					var $this = $(this);
					if (!$this.hasClass(section)) {
						if (animated) {
							$this.slideUp();
						} else {
							$this.hide();
						}
					} else {
						if (animated) {
							$this.slideDown();
						} else {
							$this.show();
						}					
					}
				})

			}

			/*
				Data helpers
			*/

			function toUnixTime(d) {
				return Math.floor(d.getTime()/1000);
			}

		  function timestamp_day(index, template) {
				return toUnixTime(new Date())
			}
		  function timestamp_month(index, template) {
				return toUnixTime(new Date())
			}
		  function timestamp_year(index, template) {
				return toUnixTime(new Date())
			}

		</script>
	</body>
</html>
