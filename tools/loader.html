<!DOCTYPE html>
<html>
	<head>
		<title>Data Loader - v1 - Stretchr</title>
		<link href="css/reset.css" rel="stylesheet" />
		<link href="css/tools.css" rel="stylesheet" />
	</head>
	<body>

		<div id="header">
			<h1>Data Loader</h1>
			<em>
				Loads bulk data into Stretchr, great for testing.
			</em>
		</div>

		<div class="section setup">

			<div class="form">
				<h2>
					Account
				</h2>
				<label>
					<span>Project name:</span>
					<input type="text" name="project-name" />
				</label>
				<label>
					<span>Public key:</span>
					<input type="text" name="public-key" />
				</label>
				<label>
					<span>Private key:</span>
					<input type="text" name="private-key" />
				</label>
			</div>
			
			<div class="form">
				<h2>
					Path
				</h2>
				<label>
					<span>Post to /</span>
					<input type="text" name="project-name" />
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em class="eg">e.g. "people" or "people/1/books"</em>
				</label>
			</div>
			
			<div class="form">
				<h2>
					Data
				</h2>
				<label>
					<span>Resource template</span>
					<textarea name="data-template">{
  "index": <%=counter%>,
  "key": "<%=hash%>",
  "date": <%=now%>,
  "time": <%=timestamp|year%>,
  "recent": <%=timestamp|month%>,
  "today": <%=timestamp|day%>,
  "custom": <%=myFunc%>
}</textarea>
					<em>Enter a collective path (i.e. does not end with an ID)</em>
					<em >
						<ul>
							<li><code><%=counter%></code> - An incremental integer</li>
							<li><code><%=hash%></code> - A random hash of alpha-numberic characters</li>
							<li><code><%=now%></code> - A unix timestamp of now</li>
							<li><code><%=timestamp|year%></code> - A random timestamp within the past year</li>
							<li><code><%=timestamp|month%></code> - A random timestamp within the past month</li>
							<li><code><%=timestamp|day%></code> - A random timestamp today</li>
							<li><code><%=myFunc%></code> - Uses the value from <code>myFunc</code> function (see Custom data functions)</li>
						</ul>
					</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Custom data functions
				</h2>
				<label>
					<span>JavaScript code</span>
					<textarea name="custom-functions">function myFunc(index, resource){ 
  return index+1;
}</textarea>
				<em>
					Write any custom code to generate values here.  You can use the function names in
					the data template
				</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Preferences
				</h2>
				<label>
					<span>Count</span>
					<select name="count">
						<option>1</option>
						<option>2</option>
						<option>3</option>
						<option>5</option>
						<option selected>10</option>
						<option>20</option>
						<option>30</option>
						<option>50</option>
						<option>100</option>
					</select>
					<em>
						The number of resources to create
					</em>
				</label>
			</div>

			<div class="form">
				<h2>
					Dry run
				</h2>
				<label>
					<span>All set?</span>
					<input type="button" value="Perform dry run" data-action="DryRun" />
				</label>
			</div>

		</div>

		<div class="section dry-run">

			<div class="form">
				<h2>
					Results
				</h2>
				<textarea class="big" name="dry-run-results"></textarea>
				<label>
					<span>Happy?</span>
					<input type="button" value="Begin making requests..." />
				</label>
				<label>
					<span>or</span>
					<input type="button" value="Make some changes" data-action="MakeChanges" />
				</label>
			</div>

		</div>

		<div class="section really-working">

			<div class="form">
				<h2>
					Please wait...
				</h2>
				<label>
					<span>Progress</span>
					<div class="progress">
						<div class="track"></div>
					</div>
				</label>
				<textarea class="big"></textarea>
			</div>

		</div>

		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="../src/stretchr.js"></script>
		<script>

			/*
				loader
				by Mat Ryer
			*/

			/*
				on ready
			*/
			$(function(){

				switchToSection("setup", false);

				$("input[type=\"button\"]").click(function(){
					var $this = $(this);
					window["on" + $this.attr("data-action")]($this);
				});

			});

			/*
				doDryRun starts the dry run.
			*/
			function onDryRun() {

				switchToSection("dry-run");
				dryRunResults = $("textarea[name='dry-run-results']").val("");

				if (!go(function(ok, data){

					// add this to the dry run results
					dryRunResults.val(
						dryRunResults.val() + data + "\n"
					);

				})) {
				
					// failed :-(
				switchToSection("setup");

				};
			
			}

			function onMakeChanges() {

				switchToSection("setup");

			}

			/*
				go generates the resources and calls handler for each
				one.
			*/
			function go(handler) {

				// execute the custom functions
				try {
					eval($("textarea[name='custom-functions']").val());
				} catch(e) {
					alert("Error executing your Custom data functions:\n\n" + e)
					return false;
				}

				var count = $("select[name='count']").val();
				var template = $("textarea[name='data-template']").val();

				// template items
				var counter = 1;

				// for each resource...
				for (var i = 0; i < count; i++) {

					var thisTemplate = template;

					thisTemplate = thisTemplate.replace("<%=counter%>", counter++);
					thisTemplate = thisTemplate.replace("<%=hash%>", Stretchr.hash(Date() + counter));
					thisTemplate = thisTemplate.replace("<%=now%>", (new Date()).getTime()/1000);

					var resource;
					try {
						resource = eval(thisTemplate);
					} catch(e) {
						// report this error to the handler
						handler(false, "Couldn't create resource object: " + e + "\n" + thisTemplate + "\n");
						continue;
					}

					alert(resource);

				}

				// success
				return true;

			}

			/*
				Opens the specified section and closes all others.
			*/
			function switchToSection(section, animated) {

				if (typeof animated == "undefined") {
					animated = true;
				}

				$("div.section").each(function(){
					var $this = $(this);
					if (!$this.hasClass(section)) {
						if (animated) {
							$this.slideUp();
						} else {
							$this.hide();
						}
					} else {
						if (animated) {
							$this.slideDown();
						} else {
							$this.show();
						}					
					}
				})

			}

		</script>
	</body>
</html>
